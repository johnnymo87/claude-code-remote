{"id":"ccr-066","title":"Add mutex to JSON session registry","description":"BUG: JSON file registry vulnerable to race conditions. Even single-process Node with Express can interleave requests:\n1. Request A reads file\n2. Request B reads file\n3. A writes new state\n4. B writes based on old state, clobbering A\n\nFix options:\n1. In-process mutex around load-modify-save\n2. Move sessions to SQLite (better-sqlite3 already shipped)\n3. In-memory authoritative map with single serialized write queue\n\nFiles: src/registry/session-registry.js\nRef: ChatGPT code review 2026-01-22","status":"open","priority":2,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:55.944047142-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:55.944047142-05:00"}
{"id":"ccr-4w2","title":"Fix cleanup logging - use rowsWritten not changes","description":"BUG: Cleanup uses msgResult.changes but Cloudflare sql.exec() returns a cursor with rowsRead/rowsWritten, NOT changes property. Cleanup metrics are wrong/misleading.\n\nCurrent (wrong):\n  const msgResult = this.sql.exec('DELETE ...');\n  console.log(msgResult.changes);  // undefined\n\nFixed:\n  const cursor = this.sql.exec('DELETE ...', oneDayAgo);\n  console.log(cursor.rowsWritten);\n\nAlso: cleanup should run via scheduled events/DO alarms, not manual /cleanup calls.\n\nFiles: ccr-worker/src/router-do.js (handleCleanup)\nRef: ChatGPT code review 2026-01-22, Cloudflare SQLite docs","status":"open","priority":3,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:40.633470145-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:40.633470145-05:00"}
{"id":"ccr-502","title":"Fix Markdown parse_mode reliability","description":"BUG: Notifications use parse_mode: 'Markdown'. If Claude output contains Telegram markdown control characters, message is rejected and returns 502.\n\nFix options:\n1. Don't use parse_mode (safest)\n2. Escape text properly before sending\n3. Use MarkdownV2 with strict escaping\n\nFiles: ccr-worker/src/router-do.js (sendTelegramMessage calls)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":3,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:55.650458511-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:55.650458511-05:00"}
{"id":"ccr-5cq","title":"Add WebSocket authentication for machine connections","description":"SECURITY CRITICAL: WebSocket endpoint /ws?machineId=X has no authentication. Anyone can:\n- Connect as any machineId\n- Receive commands intended for that machine\n- Send fake commandResult responses\n- Impersonate machines to spam Telegram via DO\n\nFix options:\n1. Require auth token in Sec-WebSocket-Protocol header\n2. Require first message to be {type:'auth', token:'...'}, close if not received in N seconds\n3. Per-machine keys in CCR_MACHINE_KEYS env var\n\nFiles: ccr-worker/src/router-do.js (handleWebSocket)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":1,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:20.870626449-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:20.870626449-05:00"}
{"id":"ccr-6a4","title":"Update session updated_at on activity","description":"BUG: sessions.updated_at only set on register. Long-running sessions (24h+) get cleaned up even if actively in use.\n\nFix: Update updated_at on meaningful activity:\n- On every routed command\n- On every notification  \n- On periodic machine heartbeat\n\nFiles: ccr-worker/src/router-do.js (routeCommand, handleNotification, consider adding heartbeat)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":3,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:40.924560685-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:40.924560685-05:00"}
{"id":"ccr-9gh","title":"Fix WebSocket reconnection race condition","description":"BUG: When machine reconnects before old socket emits 'close', the old socket's close handler deletes the NEW socket from the map. Result: machine appears offline despite being connected.\n\nCurrent (buggy):\n  this.machines.set(machineId, server);\n  server.addEventListener('close', () =\u003e {\n    this.machines.delete(machineId);  // Deletes new socket\\!\n  });\n\nFixed:\n  server.addEventListener('close', () =\u003e {\n    if (this.machines.get(machineId) === server) {\n      this.machines.delete(machineId);\n    }\n  });\n\nAlso consider proactively closing old socket when new one arrives.\n\nFiles: ccr-worker/src/router-do.js (handleWebSocket, around line 150)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":2,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:40.027128428-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:40.027128428-05:00"}
{"id":"ccr-bj1","title":"Add Telegram update deduplication","description":"BUG: Telegram can retry webhooks if response is slow/errors. Current code does network calls inline (sendTelegramMessage, answerCallbackQuery). If Telegram times out and retries:\n- Duplicate commands enqueued\n- Duplicate 'queued' messages sent\n\nFix:\n1. Respond 200 OK fast, push work into state.waitUntil()\n2. Dedupe by update.update_id or (chat_id, message_id) - track seen updates\n\nFiles: ccr-worker/src/router-do.js (handleTelegramWebhook)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":3,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:55.292069404-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:55.292069404-05:00"}
{"id":"ccr-bj6","title":"Add ack-based command queue deletion","description":"BUG: Commands deleted from queue immediately after ws.send(), with no ack. If socket dies mid-flush, commands are LOST.\n\nCurrent: send() then DELETE immediately\nProblem: No guarantee message was received\n\nFix options (increasing robustness):\n1. Wrap send+delete in try/catch, stop on send failure\n2. Add ack protocol: DO sends {type:'command', id}, machine replies {type:'ack', id}, DO deletes on ack\n3. Add per-machine max queue length to prevent unbounded growth\n\nFiles: ccr-worker/src/router-do.js (flushCommandQueue)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":2,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:40.346330625-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:40.346330625-05:00"}
{"id":"ccr-g8o","title":"Fix cross-chat token replay vulnerability","description":"SECURITY: Token lookups in /cmd and callbacks don't bind to chat_id. If a token leaks, someone can DM the bot from ANY chat and route commands to that session.\n\nCurrent (vulnerable):\n  SELECT session_id FROM messages WHERE token = ?\n\nFixed:\n  SELECT session_id FROM messages WHERE token = ? AND chat_id = ?\n\nAlso consider storing/verifying from_user_id.\n\nFiles: ccr-worker/src/router-do.js (handleTelegramWebhook, routeCommand, handleCallback)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":1,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:21.173625608-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:21.173625608-05:00"}
{"id":"ccr-mvi","title":"Add authentication to Worker HTTP endpoints","description":"SECURITY CRITICAL: All Worker endpoints are unauthenticated. Anyone who discovers the Worker URL can:\n- Register/unregister sessions (POST /sessions/*)\n- Send notifications to arbitrary chat IDs (POST /notifications/send)\n- View all sessions (GET /sessions)\n- Trigger cleanup (POST /cleanup)\n\nFix: Add CCR_API_KEY env var, require Authorization: Bearer header on all non-Telegram endpoints.\n\nFiles: ccr-worker/src/router-do.js (handleHttpRequest)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":1,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:20.54094132-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:20.54094132-05:00"}
{"id":"ccr-nyi","title":"Add rate limits and queue bounds","description":"HARDENING: No limits on:\n- Max command length\n- Max queued commands per machine\n- Max sessions stored\n\nWithout bounds, unbounded growth possible (DoS vector).\n\nFix: Add configurable limits, drop/compact old commands when exceeded.\n\nFiles: ccr-worker/src/router-do.js (enqueueCommand, handleSessionRegister)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":3,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:47:01.787101332-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:47:01.787101332-05:00"}
{"id":"ccr-vt2","title":"Add Telegram chat/user allowlist","description":"SECURITY: No access control on who can interact with the bot. If bot is discoverable or added to groups, anyone can attempt to route commands.\n\nFix: Add ALLOWED_CHAT_IDS and ALLOWED_USER_IDS env vars. Reject requests from unlisted sources early in webhook handler. Optionally reject group chats unless explicitly enabled.\n\nFiles: ccr-worker/src/router-do.js (handleTelegramWebhook - add early check)\nRef: ChatGPT code review 2026-01-22","status":"open","priority":1,"issue_type":"task","owner":"jonathan.mohrbacher@gmail.com","created_at":"2026-01-22T16:46:21.456566829-05:00","created_by":"Jonathan Mohrbacher","updated_at":"2026-01-22T16:46:21.456566829-05:00"}
